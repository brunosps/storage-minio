#!/bin/bash
# Script para gerenciar usu√°rios e buckets no MinIO
# Cada bucket principal ter√° 3 pastas internas: images, public, uploads

set -e

# Carregar vari√°veis de ambiente
if [[ -f "../.env" ]]; then
    source "../.env"
elif [[ -f ".env" ]]; then
    source ".env"
else
    echo "‚ùå Arquivo .env n√£o encontrado!"
    echo "üìã Crie um arquivo .env baseado no .env.example"
    echo "   cp .env.example .env"
    echo "   # Edite o .env com suas credenciais"
    exit 1
fi

# Verificar se as vari√°veis necess√°rias est√£o definidas
if [[ -z "$MINIO_ENDPOINT" || -z "$MINIO_ROOT_USER" || -z "$MINIO_ROOT_PASSWORD" ]]; then
    echo "‚ùå Vari√°veis de ambiente obrigat√≥rias n√£o definidas!"
    echo "üìã Certifique-se de definir no .env:"
    echo "   MINIO_ENDPOINT=https://s3.techdb.app"
    echo "   MINIO_ROOT_USER=admin"
    echo "   MINIO_ROOT_PASSWORD=sua_senha"
    exit 1
fi

# Configura√ß√µes
MINIO_ENDPOINT="${MINIO_ENDPOINT}"
MINIO_USER="${MINIO_ROOT_USER}"
MINIO_PASS="${MINIO_ROOT_PASSWORD}"
ALIAS="${MINIO_ALIAS:-s3admin}"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fun√ß√£o para mostrar menu
show_menu() {
    echo ""
    echo "üîß GERENCIADOR DE USU√ÅRIOS E BUCKETS MinIO"
    echo "=========================================="
    echo ""
    echo "1. üë§ Criar novo usu√°rio"
    echo "2. üìÅ Criar novo bucket (com sub-buckets)"
    echo "3. üîó Vincular usu√°rio a bucket"
    echo "4. üìã Listar usu√°rios"
    echo "5. üìã Listar buckets"
    echo "6. üóëÔ∏è Remover usu√°rio"
    echo "7. üóëÔ∏è Remover bucket"
    echo "8. üß™ Testar acesso de usu√°rio"
    echo "9. ‚ùå Sair"
    echo ""
    echo -n "Escolha uma op√ß√£o: "
}

# Fun√ß√£o para conectar ao MinIO
connect_minio() {
    echo "üîê Conectando ao MinIO..."
    mc alias set $ALIAS $MINIO_ENDPOINT $MINIO_USER $MINIO_PASS > /dev/null
    echo "‚úÖ Conectado com sucesso!"
}

# Fun√ß√£o para criar usu√°rio
create_user() {
    echo ""
    echo "üë§ CRIAR NOVO USU√ÅRIO"
    echo "===================="
    
    echo -n "Nome do usu√°rio: "
    read username
    
    if [[ -z "$username" ]]; then
        echo "‚ùå Nome do usu√°rio n√£o pode estar vazio!"
        return 1
    fi
    
    echo -n "Senha do usu√°rio (deixe vazio para gerar automaticamente): "
    read -s password
    echo ""
    
    if [[ -z "$password" ]]; then
        password="${username}-$(date +%s)-pass"
        echo "üîë Senha gerada automaticamente: $password"
    fi
    
    echo -n "Tipo de acesso (full/readonly) [full]: "
    read access_type
    access_type=${access_type:-full}
    
    # Criar usu√°rio
    echo "üìù Criando usu√°rio $username..."
    mc admin user add $ALIAS $username $password
    
    echo "‚úÖ Usu√°rio $username criado com sucesso!"
    echo "üîê Credenciais:"
    echo "   Username: $username"
    echo "   Password: $password"
    echo "   Access Type: $access_type"
    
    # Salvar credenciais em arquivo
    echo "$username:$password:$access_type:$(date)" >> users.txt
    echo "üíæ Credenciais salvas em users.txt"
}

# Fun√ß√£o para criar bucket com sub-buckets
create_bucket() {
    echo ""
    echo "üìÅ CRIAR NOVO BUCKET"
    echo "==================="
    
    echo -n "Nome do bucket principal: "
    read bucket_name
    
    if [[ -z "$bucket_name" ]]; then
        echo "‚ùå Nome do bucket n√£o pode estar vazio!"
        return 1
    fi
    
    echo "üì¶ Criando estrutura de pastas para: $bucket_name"
    echo ""
    
    # Pastas que ser√£o criadas dentro do bucket
    folders=("images" "public" "uploads")
    
    # Criar bucket principal
    echo "üìÅ Criando bucket principal: $bucket_name"
    mc mb $ALIAS/$bucket_name 2>/dev/null || echo "‚ö†Ô∏è Bucket $bucket_name j√° existe"
    
    # Criar pastas dentro do bucket (usando arquivos .keep para criar as pastas)
    for folder in "${folders[@]}"; do
        echo "üìÇ Criando pasta: $bucket_name/$folder/"
        echo "# Pasta criada automaticamente em $(date)" | mc pipe $ALIAS/$bucket_name/$folder/.keep
    done
    
    echo ""
    echo "‚úÖ Estrutura de pastas criada:"
    echo "   üìÅ $bucket_name/"
    echo "   üìÇ   ‚îú‚îÄ‚îÄ images/"
    echo "   üìÇ   ‚îú‚îÄ‚îÄ public/"
    echo "   üìÇ   ‚îî‚îÄ‚îÄ uploads/"
    
    # Configurar pol√≠tica p√∫blica para toda a pasta public dentro do bucket
    echo ""
    echo "üåê Configurando acesso p√∫blico para $bucket_name/public/..."
    mc anonymous set public $ALIAS/$bucket_name
    echo "‚úÖ Bucket $bucket_name configurado como p√∫blico (pasta public/ acess√≠vel)"
    
    # Criar pol√≠tica espec√≠fica para este conjunto de buckets
    create_bucket_policy $bucket_name
}

# Fun√ß√£o para criar pol√≠tica espec√≠fica do bucket
create_bucket_policy() {
    local bucket_name=$1
    
    echo "üìú Criando pol√≠tica para bucket $bucket_name..."
    
    # Pol√≠tica de acesso total ao bucket (todas as pastas)
    cat > /tmp/${bucket_name}-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::${bucket_name}",
        "arn:aws:s3:::${bucket_name}/*"
      ]
    }
  ]
}
EOF
    
    # Pol√≠tica somente leitura
    cat > /tmp/${bucket_name}-readonly-policy.json << EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::${bucket_name}",
        "arn:aws:s3:::${bucket_name}/*"
      ]
    }
  ]
}
EOF
    
    # Criar pol√≠ticas no MinIO
    mc admin policy create $ALIAS ${bucket_name}-access /tmp/${bucket_name}-policy.json
    mc admin policy create $ALIAS ${bucket_name}-readonly /tmp/${bucket_name}-readonly-policy.json
    
    # Limpar arquivos tempor√°rios
    rm -f /tmp/${bucket_name}-policy.json /tmp/${bucket_name}-readonly-policy.json
    
    echo "‚úÖ Pol√≠ticas criadas: ${bucket_name}-access e ${bucket_name}-readonly"
}

# Fun√ß√£o para vincular usu√°rio a bucket
link_user_bucket() {
    echo ""
    echo "üîó VINCULAR USU√ÅRIO A BUCKET"
    echo "============================"
    
    echo "üë• Usu√°rios dispon√≠veis:"
    mc admin user list $ALIAS 2>/dev/null | grep -v "^Access" | head -10
    echo ""
    echo -n "Nome do usu√°rio: "
    read username
    
    echo ""
    echo "üìÅ Buckets dispon√≠veis:"
    mc ls $ALIAS/ | grep -E "/$" | sed 's/.*\s//' | sed 's/\///' | head -20
    echo ""
    echo -n "Nome do bucket (sem sub-buckets): "
    read bucket_name
    
    echo -n "Tipo de acesso (full/readonly) [full]: "
    read access_type
    access_type=${access_type:-full}
    
    # Definir pol√≠tica baseada no tipo de acesso
    if [[ "$access_type" == "readonly" ]]; then
        policy_name="${bucket_name}-readonly"
    else
        policy_name="${bucket_name}-access"
    fi
    
    echo "üîó Vinculando usu√°rio $username ao bucket $bucket_name com acesso $access_type..."
    
    # Verificar se pol√≠tica existe
    if mc admin policy info $ALIAS $policy_name >/dev/null 2>&1; then
        mc admin policy attach $ALIAS $policy_name --user $username
        echo "‚úÖ Usu√°rio $username vinculado com sucesso!"
        echo "üìã Acesso concedido ao bucket:"
        echo "   üìÅ $bucket_name/"
        echo "   üìÇ   ‚îú‚îÄ‚îÄ images/"
        echo "   üìÇ   ‚îú‚îÄ‚îÄ public/"
        echo "   üìÇ   ‚îî‚îÄ‚îÄ uploads/"
    else
        echo "‚ùå Pol√≠tica $policy_name n√£o encontrada. Crie o bucket primeiro."
    fi
}

# Fun√ß√£o para listar usu√°rios
list_users() {
    echo ""
    echo "üë• USU√ÅRIOS CADASTRADOS"
    echo "======================"
    
    echo "üîê Usu√°rios no MinIO:"
    mc admin user list $ALIAS 2>/dev/null || echo "‚ùå Erro ao listar usu√°rios"
    
    echo ""
    if [[ -f "users.txt" ]]; then
        echo "üìã Hist√≥rico de usu√°rios criados:"
        echo "Username:Password:AccessType:Created"
        echo "--------------------------------"
        cat users.txt
    else
        echo "üìã Nenhum hist√≥rico de usu√°rios encontrado"
    fi
}

# Fun√ß√£o para listar buckets
list_buckets() {
    echo ""
    echo "üìÅ BUCKETS CADASTRADOS"
    echo "======================"
    
    echo "üìã Todos os buckets:"
    mc ls $ALIAS/ 2>/dev/null || echo "‚ùå Erro ao listar buckets"
    
    echo ""
    echo "üèóÔ∏è Estruturas de buckets detectadas:"
    mc ls $ALIAS/ 2>/dev/null | grep -E "/$" | sed 's/.*\s//' | sed 's/\///' | \
    while read bucket; do
        # Verificar se tem as pastas padr√£o dentro do bucket
        if mc ls $ALIAS/$bucket/images/ >/dev/null 2>&1 && \
           mc ls $ALIAS/$bucket/public/ >/dev/null 2>&1 && \
           mc ls $ALIAS/$bucket/uploads/ >/dev/null 2>&1; then
            echo "üì¶ $bucket/ (com pastas completas: images/, public/, uploads/)"
        else
            echo "üìÅ $bucket/ (bucket simples)"
        fi
    done
}

# Fun√ß√£o para remover usu√°rio
remove_user() {
    echo ""
    echo "üóëÔ∏è REMOVER USU√ÅRIO"
    echo "=================="
    
    echo "üë• Usu√°rios dispon√≠veis:"
    mc admin user list $ALIAS 2>/dev/null | grep -v "^Access"
    echo ""
    echo -n "Nome do usu√°rio para remover: "
    read username
    
    if [[ -z "$username" ]]; then
        echo "‚ùå Nome do usu√°rio n√£o pode estar vazio!"
        return 1
    fi
    
    echo -n "Tem certeza que deseja remover o usu√°rio $username? (s/N): "
    read confirm
    
    if [[ "$confirm" =~ ^[Ss]$ ]]; then
        mc admin user remove $ALIAS $username
        echo "‚úÖ Usu√°rio $username removido com sucesso!"
        
        # Remover do arquivo de hist√≥rico
        if [[ -f "users.txt" ]]; then
            grep -v "^$username:" users.txt > users.txt.tmp && mv users.txt.tmp users.txt
        fi
    else
        echo "‚ùå Opera√ß√£o cancelada"
    fi
}

# Fun√ß√£o para remover bucket
remove_bucket() {
    echo ""
    echo "üóëÔ∏è REMOVER BUCKET"
    echo "================="
    
    echo "üìÅ Buckets dispon√≠veis:"
    mc ls $ALIAS/ | grep -E "/$" | sed 's/.*\s//' | sed 's/\///'
    echo ""
    echo -n "Nome do bucket principal para remover (remover√° todas as pastas internas): "
    read bucket_name
    
    if [[ -z "$bucket_name" ]]; then
        echo "‚ùå Nome do bucket n√£o pode estar vazio!"
        return 1
    fi
    
    echo -n "Tem certeza que deseja remover $bucket_name e todas as pastas internas? (s/N): "
    read confirm
    
    if [[ "$confirm" =~ ^[Ss]$ ]]; then
        # Remover todo o conte√∫do do bucket (incluindo todas as pastas)
        echo "üóëÔ∏è Removendo todo o conte√∫do de $bucket_name..."
        mc rm --recursive --force $ALIAS/$bucket_name/ 2>/dev/null || true
        
        # Remover bucket principal
        echo "üóëÔ∏è Removendo bucket $bucket_name..."
        mc rb $ALIAS/$bucket_name 2>/dev/null || true
        
        # Remover pol√≠ticas
        mc admin policy remove $ALIAS ${bucket_name}-access 2>/dev/null || true
        mc admin policy remove $ALIAS ${bucket_name}-readonly 2>/dev/null || true
        
        echo "‚úÖ Bucket $bucket_name e todas as pastas removidos com sucesso!"
    else
        echo "‚ùå Opera√ß√£o cancelada"
    fi
}

# Fun√ß√£o para testar acesso
test_user_access() {
    echo ""
    echo "üß™ TESTAR ACESSO DE USU√ÅRIO"
    echo "==========================="
    
    echo -n "Nome do usu√°rio: "
    read username
    echo -n "Senha do usu√°rio: "
    read -s password
    echo ""
    
    # Configurar alias de teste
    test_alias="test-${username}"
    mc alias set $test_alias $MINIO_ENDPOINT $username $password
    
    echo "üîç Testando acesso para usu√°rio $username..."
    echo ""
    
    echo "üìÅ Buckets vis√≠veis:"
    mc ls $test_alias/ 2>/dev/null || echo "‚ùå Erro ao acessar buckets"
    
    echo ""
    echo "üì§ Testando upload (arquivo de teste)..."
    echo "Teste de upload - $(date)" > /tmp/test-upload.txt
    
    # Tentar upload em buckets vis√≠veis
    mc ls $test_alias/ 2>/dev/null | grep -E "/$" | sed 's/.*\s//' | sed 's/\///' | head -3 | \
    while read bucket; do
        echo "üìÇ Testando upload em $bucket..."
        mc cp /tmp/test-upload.txt $test_alias/$bucket/ 2>/dev/null && \
        echo "   ‚úÖ Upload bem-sucedido" || \
        echo "   ‚ùå Upload falhou"
    done
    
    rm -f /tmp/test-upload.txt
}

# Script principal
main() {
    echo "üöÄ Iniciando Gerenciador MinIO..."
    
    # Conectar ao MinIO
    connect_minio
    
    while true; do
        show_menu
        read choice
        
        case $choice in
            1) create_user ;;
            2) create_bucket ;;
            3) link_user_bucket ;;
            4) list_users ;;
            5) list_buckets ;;
            6) remove_user ;;
            7) remove_bucket ;;
            8) test_user_access ;;
            9) 
                echo "üëã Saindo..."
                exit 0
                ;;
            *)
                echo "‚ùå Op√ß√£o inv√°lida!"
                ;;
        esac
        
        echo ""
        echo -n "Pressione Enter para continuar..."
        read
    done
}

# Verificar se est√° sendo executado diretamente
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
